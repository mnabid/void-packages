# Template file for 'onlyoffice'
pkgname=onlyoffice
version=9.2.1
revision=1
archs="x86_64"
create_wrksrc=yes
depends="alsa-lib desktop-file-utils gstreamer1 gst-plugins-base1 gst-plugins-ugly1
 gtk+3 libcurl libXScrnSaver nspr nss libpulseaudio dejavu-fonts-ttf liberation-fonts-ttf"
short_desc="Office suite that combines text, spreadsheet and presentation editors"
maintainer="Nafis <mnabid.25@outlook.com>"
license="AGPL-3.0-only"
homepage="https://www.onlyoffice.com/"
distfiles="https://github.com/ONLYOFFICE/DesktopEditors/releases/download/v${version}/onlyoffice-desktopeditors_amd64.deb"
checksum=ae453f124249e5dfa99601b71d5e00f655adc890158130d439467d7741e3969e
nostrip=yes

do_extract() {
	bsdtar -xf "${XBPS_SRCDISTDIR}/${pkgname}-${version}/onlyoffice-desktopeditors_amd64.deb"
	bsdtar -xf data.tar.xz
}

do_install() {
	vcopy opt .
	vcopy usr .

	# Fix document opening via .desktop file
	sed -i '/Exec/ s/%U/%F/' "${DESTDIR}/usr/share/applications/onlyoffice-desktopeditors.desktop"

	# Handle icons
	find "${DESTDIR}/opt/onlyoffice/desktopeditors" -maxdepth 1 -type f -name 'asc-de-*.png' | while read -r _file; do
		# Extract resolution from filename (e.g., asc-de-48.png -> 48)
		local _res
		_res=$(basename "$_file" .png | sed 's/^.*-//')

		# Create directory and symlink
		vmkdir "usr/share/icons/hicolor/${_res}x${_res}/apps"
		ln -sf "/opt/onlyoffice/desktopeditors/asc-de-${_res}.png" \
			"${DESTDIR}/usr/share/icons/hicolor/${_res}x${_res}/apps/onlyoffice-desktopeditors.png"
	done
}
